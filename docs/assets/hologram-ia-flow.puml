
@startuml Hologram Agent-IA

title Hologram Agent-IA Message Flow

actor User
participant "CoreService" as CS
participant "ChatbotService" as Chatbot
participant "ApiClient" as API

== Connection Established ==
User -> CS : newConnection(connectionId)
CS -> CS : handleSession()
CS -> CS : sendContextualMenu()

== Profile Received ==
User -> CS : ProfileMessage
CS -> CS : handleSession()
CS -> CS : update lang
CS -> CS : sendGreetingMessage()
CS -> API : send(TextMessage with greeting)

== Menu Selection ==
User -> CS : ContextualMenuSelectMessage
CS -> CS : handleContextualAction()
alt Authenticate
    CS -> API : send(IdentityProofRequestMessage)
    CS -> API : send(TextMessage AUTH_PROCESS_STARTED)
    CS -> CS : state = AUTH
else Logout
    CS -> CS : isAuthenticated = false
    CS -> CS : purgeUserData()
end

== TextMessage Input ==
User -> CS : TextMessage
CS -> CS : handleStateInput()
alt state == CHAT
    alt needsAuth && !isAuthenticated
        CS -> API : send(TextMessage AUTH_REQUIRED)
    else
        CS -> Chatbot : chat()
        Chatbot -> CS : answer
        CS -> API : send(TextMessage answer)
    end
else state == AUTH
    alt CredentialReceptionMessage && state == done
        CS -> CS : isAuthenticated = true
        CS -> CS : state = CHAT
        CS -> API : send(TextMessage AUTH_SUCCESS)
    else
        CS -> API : send(TextMessage WAITING_CREDENTIAL)
    end
end

== Menu Update ==
CS -> API : send(ContextualMenuUpdateMessage)

@enduml
